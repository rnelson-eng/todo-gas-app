<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#f4f6f9; }
    .container { display:flex; height:100vh; }
    .sidebar { background:#2f4f72; color:#fff; width:250px; padding:20px; }
    .sidebar h2 { font-size:20px; margin-top:0; }
    .sidebar ul { list-style:none; padding:0; }
    .sidebar li { margin:10px 0; cursor:pointer; }
    .sidebar li:hover { text-decoration:underline; }
    .main { flex:1; padding:20px; background:#fff; }
    .main h2 { margin-top:0; color:#2f4f72; }
    .task-table { width:100%; border-collapse:collapse; }
    .task-table th,.task-table td { border-bottom:1px solid #ddd; padding:10px; text-align:left; }
    .task-table th { background:#e1e8f0; }
    .task-row:hover { background:#f2f7fc; }
    .add-task { margin-top:20px; padding:10px; background:#f9f9f9; border:1px solid #ccc; }
    .add-task input,.add-task select { padding:6px; margin:4px 8px 4px 0; }
    .add-task button { background:#2f4f72; color:#fff; padding:6px 12px; border:none; cursor:pointer; }
    .add-task button:hover { background:#3b5e89; }
  </style>
  <script>
  // write a message in the UI for quick diagnosis
  function dbg(msg) {
    const el = document.getElementById('debug');
    if (el) el.textContent = String(msg || '');
  }

  // render rows into the existing table
  function renderTasks(tasks) {
    const tbody = document.querySelector(".task-table tbody");
    if (!tbody) { dbg("No .task-table tbody found."); return; }

    tbody.innerHTML = "";
    (tasks || []).forEach(t => {
      const tr = document.createElement("tr");
      const due = t.dueDate ? new Date(t.dueDate).toLocaleDateString() : "";
      tr.innerHTML = `
        <td><input type="checkbox" ${t.completed ? "checked" : ""}></td>
        <td>${t.task || ""}</td>
        <td>${t.category || ""}</td>
        <td>${due}</td>
        <td>${t.info || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    dbg(`Loaded ${tasks.length} task(s).`);
  }

  // try to fetch from server
  function loadTasks() {
    if (!window.google || !google.script || !google.script.run) {
      dbg("Bridge not readyâ€¦ retrying");
      setTimeout(loadTasks, 150);
      return;
    }
    google.script.run
      .withSuccessHandler(function (rows) {
        if (!rows || !rows.length) dbg("Server returned 0 tasks.");
        renderTasks(rows || []);
      })
      .withFailureHandler(function (err) {
        console.error("getTasks failed:", err);
        dbg("getTasks failed: " + (err && err.message ? err.message : err));
        // Fallback: render a dummy row so we confirm the renderer works
        renderTasks([{ task: "âš  Could not load from server", category: "", dueDate: "", info: "Check Code.js:getTasks()", completed: false }]);
      })
      .getTasks();
  }

  function addTask() {
    const inputs = document.querySelectorAll(".add-task input, .add-task select");
    if (inputs.length < 5) { dbg("Add-task inputs not found."); return; }

    const name     = (inputs[0]?.value || "").trim();
    const dueDate  = (inputs[1]?.value || "");
    const category = (inputs[2]?.value || "");
    const hot      = !!(inputs[3]?.checked);
    const info     = (inputs[4]?.value || "").trim();

    if (!name) { alert("Please enter a task name."); return; }

    const payload = { name, dueDate, category, info, hot };

    google.script.run
      .withSuccessHandler(function () {
        inputs.forEach(el => { if (el.type === "checkbox") el.checked = false; else el.value = ""; });
        dbg("Task added. Refreshingâ€¦");
        loadTasks();
      })
      .withFailureHandler(function (err) {
        console.error("addTask failed:", err);
        dbg("addTask failed: " + (err && err.message ? err.message : err));
      })
      .addTask(payload);
  }

  function wireUI() {
    const addBtn = document.querySelector(".add-task button");
    if (addBtn) addBtn.addEventListener("click", addTask);
    else dbg("Add button not found.");
  }

  document.addEventListener("DOMContentLoaded", function () {
    dbg("DOM ready. Loading tasksâ€¦");
    wireUI();
    loadTasks();
  });
</script>

</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>CATEGORIES</h2>
      <ul>
        <li>ðŸ”¥ Hot Tasks</li>
        <li>â˜‘ Completed Tasks</li>
        <li>ðŸŸ¢ All Tasks</li>
        <li>â–¸ Morning Routine</li>
        <li>â–¸ School</li>
        <li>â–¸ Personal</li>
        <li>â–¸ Admin</li>
        <li>âž• Add Category</li>
      </ul>
    </div>

    <div class="main">
      <h2>ðŸ“‹ TASKS</h2>
      <table class="task-table">
        <thead>
          <tr>
            <th></th>
            <th>Task</th>
            <th>Category</th>
            <th>Due Date</th>
            <th>Info</th>
          </tr>
        </thead>
        <tbody><!-- rows injected by JS --></tbody>
      </table>

      <div id="debug" style="margin:8px 0;color:#b00;font-weight:600;"></div>

      <div class="add-task">
        <h3>âž• ADD NEW TASK</h3>
        <input type="text" placeholder="Task">
        <input type="date">
        <select>
          <option>School</option>
          <option>Admin</option>
          <option>Morning</option>
          <option>Personal</option>
        </select>
        <label><input type="checkbox"> Mark as Hot?</label><br>
        <input type="text" placeholder="Info (optional)">
        <button type="button">+ Add Task</button>
      </div>
    </div>
  </div>
</body>
</html>
